# Customizing Default Templates (Story 3.10)

## Overview

Steno comes with three default system templates that are automatically created for each law firm when they sign up:

1. **Personal Injury Demand Letter** - For personal injury claims with medical expenses, lost wages, and pain and suffering
2. **Contract Dispute Demand Letter** - For breach of contract claims
3. **Property Damage Demand Letter** - For property damage claims with repair costs and loss of use

These templates are marked as "system templates" (`isSystemTemplate: true`) and serve as starting points for common legal scenarios.

## How System Templates Work

### Automatic Creation

When a new firm is created during database seeding or user signup:

1. All three default templates are automatically created for the firm
2. Templates are marked with `isSystemTemplate: true` and `isActive: true`
3. Initial version records (version 1) are created for version tracking
4. Templates are immediately visible in the template gallery

### Firm-Specific Copies

System templates cannot be modified directly. Instead:

1. When a firm wants to customize a system template, the UI creates a **firm-specific copy**
2. The copy has `isSystemTemplate: false` and belongs to the firm
3. The firm can then edit their copy without affecting other firms
4. The original system template remains unchanged as a fallback

## Customizing Templates

### Via Template Builder UI

1. Navigate to the **Templates** page in your dashboard
2. Find the system template you want to customize
3. Click **"Customize"** or **"Create Copy"**
4. The system creates a firm-specific copy you can edit
5. Make your changes to sections, variables, or prompt guidance
6. Save your customized template

Your customized version will now appear alongside the system template in the gallery.

### Editing Template Structure

Templates consist of:

#### 1. **Sections** (AC #4)

Each section has:
- **ID**: Unique identifier
- **Title**: Display name (e.g., "Statement of Facts")
- **Type**: One of:
  - `static` - Fixed content with variable placeholders
  - `ai_generated` - Generated by AI using prompt guidance
  - `variable` - User-entered content with variable placeholders
- **Content**: Template text (for static/variable sections)
- **Prompt Guidance**: Instructions for AI generation (for ai_generated sections)
- **Required**: Whether the section is mandatory
- **Order**: Display order (1, 2, 3, etc.)

Example section:
```typescript
{
  id: 'facts',
  title: 'Statement of Facts',
  type: 'ai_generated',
  content: null,
  promptGuidance: 'Generate a detailed chronological narrative of the accident based on the source documents. Include specific details about the location, time, weather conditions, and sequence of events leading to the injury. Emphasize facts that establish defendant liability.',
  required: true,
  order: 2
}
```

#### 2. **Variables** (AC #5)

Each variable has:
- **Name**: Variable identifier (e.g., `plaintiff_name`, `incident_date`)
- **Type**: One of: `text`, `number`, `date`, `currency`
- **Required**: Whether the variable must be filled
- **Default Value**: Optional default value

Variables are referenced in sections using double braces: `{{variable_name}}`

Example variable:
```typescript
{
  name: 'plaintiff_name',
  type: 'text',
  required: true,
  defaultValue: null
}
```

## Modifying Default Templates (Admin)

If you need to update the **system-wide default templates** (affects all new firms):

### 1. Edit the Seed Script

The default templates are defined in `/lib/db/seed.ts` inside the `createTemplatesForFirm()` function.

**Personal Injury Template**: Lines 129-241
**Contract Dispute Template**: Lines 243-349
**Property Damage Template**: Lines 351-478

### 2. Update Template Structure

To add a new section:
```typescript
{
  id: 'new_section',
  title: 'New Section Title',
  type: 'ai_generated', // or 'static' or 'variable'
  content: null, // or template text for static sections
  promptGuidance: 'Instructions for AI on what to generate...',
  required: true,
  order: 5 // increment order number
}
```

To add a new variable:
```typescript
{
  name: 'new_variable',
  type: 'text', // or 'number', 'date', 'currency'
  required: false,
  defaultValue: null
}
```

### 3. Validation Rules

The seed script validates:
- **Variable uniqueness**: No duplicate variable names within a template
- **Variable references**: All `{{variable_name}}` references in sections must be defined in the variables array
- **AI section guidance**: All `ai_generated` sections must have `promptGuidance`
- **Section ordering**: Sections must have sequential order numbers (1, 2, 3, ...)

### 4. Run Updated Seed

After modifying the seed script:

```bash
# Clear existing data and re-seed
npm run db:seed

# Verify templates were created correctly
npm run db:verify-templates
```

## Template Best Practices

### Writing Prompt Guidance (AC #4)

Good prompt guidance should:
1. **Be specific**: "Generate a detailed chronological narrative..." not "Describe what happened"
2. **Reference source documents**: "...based on the source documents"
3. **Provide context**: Explain what information to include and why
4. **Set tone**: Professional legal writing expected
5. **Be comprehensive**: 2-4 sentences minimum

Example:
```
"Describe the plaintiff's injuries in detail based on medical records. Include
diagnoses, treatment received, ongoing care requirements, and prognosis. Use
medical terminology appropriately while remaining understandable."
```

### Organizing Sections

Common demand letter structure:
1. Introduction (static)
2. Facts/Background (ai_generated)
3. Liability/Breach (ai_generated)
4. Damages/Injuries (ai_generated)
5. Financial Summary (variable)
6. Demand (static)
7. Closing (static)

### Variable Naming

Use clear, descriptive names:
- ✅ `plaintiff_name`, `incident_date`, `medical_expenses`
- ❌ `name`, `date`, `amount`

Use underscores, not camelCase: `total_demand` not `totalDemand`

## Testing Templates

### Manual Testing

1. Create a new project using the template
2. Fill in all required variables
3. Upload sample source documents
4. Generate the demand letter
5. Review AI-generated sections for quality
6. Check variable substitution

### Automated Testing

The test suite (`/lib/db/__tests__/seed.test.ts`) validates:
- Template counts per firm
- Required template types present
- System template flags set correctly
- Section structure and types
- Variable definitions and types
- AI sections have prompt guidance
- Version history created

Run tests:
```bash
npm run test lib/db/__tests__/seed.test.ts
```

## API Endpoints for Templates

Templates are accessible via:

- `GET /api/templates` - List all templates for the firm (includes system templates)
- `GET /api/templates/:id` - Get specific template
- `POST /api/templates` - Create new template (creates firm-specific copy)
- `PUT /api/templates/:id` - Update template (only firm-owned, not system templates)
- `POST /api/templates/:id/copy` - Create a copy of a system template

System templates can be read but not modified through the API. Attempting to update a system template returns an error.

## Architecture Notes

From `/docs/architecture.md`:

> Templates are firm-specific and define the structure for AI generation.

System templates extend this by:
1. Being automatically created for each firm
2. Serving as read-only reference templates
3. Being copyable but not editable
4. Providing consistent starting points across all firms

## Acceptance Criteria Checklist (Story 3.10)

- [x] AC #1: Database seed creates 2-3 default templates for each firm
- [x] AC #2: Templates include Personal Injury, Contract Dispute, and Property Damage
- [x] AC #3: Default templates marked as system templates
- [x] AC #4: Templates include well-crafted prompt guidance for AI sections
- [x] AC #5: Variables defined for each template type
- [x] AC #6: Seed script runs during initial database setup (`npm run db:seed`)
- [x] AC #7: Templates visible in gallery immediately after user signup
- [x] AC #8: Templates can be edited/customized by firms (creates firm-specific copy)
- [x] AC #9: Documentation explains how to customize default templates (this file)
- [ ] AC #10: Sample templates reviewed by legal expert for appropriateness (pending)

## Future Enhancements

Potential improvements for future stories:

1. **Template Library**: Allow sharing of firm-specific templates across firms
2. **Template Import/Export**: Export templates as JSON for backup or sharing
3. **Template Preview**: Show rendered template with sample data
4. **Template Analytics**: Track which templates are most used
5. **Template Validation**: Check for common errors before saving
6. **Variable Suggestions**: Auto-suggest variables based on section content
7. **AI Prompt Testing**: Test prompt guidance with sample documents before saving
